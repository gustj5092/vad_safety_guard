# VAD Safety Guard: Kinematic Safety Layer for End-to-End Autonomous Driving

## üìå Overview
**VAD Safety Guard** is a safety verification module designed for VAD (Vectorized Autonomous Driving) models. 
End-to-end autonomous driving models often generate physically infeasible trajectories under system delays or fail to account for vehicle dynamics. This node acts as a **Safety Filter**, verifying candidate trajectories based on kinematic constraints and intervening when necessary to prevent accidents.

### Key Features
* **Latency Compensation:** Accounts for system delay ($\tau$) in safety checks.
* **Kinematic Feasibility Check:** Verifies both lateral (curvature) and longitudinal (stopping distance) safety.
* **Active Intervention:** Rejects risky trajectories (Rank 0) and selects safer alternatives (Rank $N$).
* **Temporal Consistency:** Selects trajectories that ensure smooth control continuity.

---

## üõ†Ô∏è Methodology (Core Algorithm)

The Safety Guard processes $N$ candidate trajectories $\{T_0, T_1, ..., T_N\}$ generated by the VAD model and selects the optimal trajectory $T^*$ based on the following physical models.

### 1. Lateral Safety (Curvature Constraint)
To prevent lateral instability (oscillation) and rollover, we verify the **Lateral Acceleration ($a_{lat}$)** based on the path curvature.
The curvature $\kappa$ is calculated using the **Menger Curvature** formula for three consecutive points ($P_1, P_2, P_3$):

$$
\kappa = \frac{4 \cdot \text{Area}(P_1, P_2, P_3)}{|P_1 P_2| \cdot |P_2 P_3| \cdot |P_3 P_1|}
$$

The trajectory is considered **Infeasible** if the lateral acceleration at current velocity $v$ exceeds the limit $a_{lat}^{max}$:

$$
a_{lat} = v^2 \cdot \kappa \quad \text{s.t.} \quad a_{lat} \le a_{lat}^{max}
$$

### 2. Longitudinal Safety (Stopping Distance Constraint)
To prevent collisions under system delay ($\tau$), we calculate the **Required Stopping Distance ($d_{req}$)**. This accounts for the free-running distance during the delay and the physical braking distance.

$$
d_{req} = \underbrace{v \cdot \tau}_{\text{Reaction Distance}} + \underbrace{\frac{v^2}{2 \cdot |a_{long}^{max}|}}_{\text{Braking Distance}}
$$

A stopping trajectory is considered **Infeasible** if its length $L_{path}$ is insufficient:

$$
\text{Condition: } L_{path} \ge d_{req}
$$

### 3. Optimization Strategy (Temporal Consistency)
Among the trajectories that pass the feasibility checks (Set $S_{feasible}$), the final trajectory $T^*$ is selected to minimize the change in curvature compared to the previous control step ($\kappa_{prev}$). This ensures smooth steering control.

$$
T^* = \operatorname*{argmin}_{t \in S_{feasible}} | \bar{\kappa}(t) - \kappa_{prev} |
$$

If $S_{feasible} = \emptyset$ (all candidates are risky), the system triggers an **Emergency Stop**.

---

## üìä System Architecture

```mermaid
graph TD
    A[VAD Model Output<br>(Candidate Trajectories)] --> B{Feasibility Check<br>(Lateral & Longitudinal)}
    B -- Infeasible --> C[Discard Candidate]
    B -- Feasible --> D[Add to Feasible Set]
    D --> E{Is Set Empty?}
    E -- Yes --> F[Generate Emergency Stop<br>(Max Deceleration)]
    E -- No --> G[Optimization<br>(Select Min Curvature Diff)]
    F --> H[Final Control Command]
    G --> H
